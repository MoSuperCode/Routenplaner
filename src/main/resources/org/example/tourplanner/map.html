<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tour Route Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin="" />
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
        }

        #map {
            height: 500px;
            width: 100%;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .map-container {
            padding: 20px;
            background: white;
            border-radius: 12px;
            margin: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .tour-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 15px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 8px;
        }

        .tour-details {
            display: flex;
            gap: 30px;
        }

        .detail-item {
            text-align: center;
        }

        .detail-value {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .detail-label {
            font-size: 12px;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .route-info {
            background: #e8f4f8;
            border: 1px solid #b3d9e6;
            border-radius: 6px;
            padding: 12px;
            margin-top: 15px;
            display: none;
        }

        .route-info.show {
            display: block;
        }

        .custom-popup {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .popup-title {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .error {
            background: #ffe6e6;
            border: 1px solid #ffcccc;
            color: #cc0000;
            padding: 12px;
            border-radius: 6px;
            margin-top: 15px;
        }
    </style>
</head>
<body>
<div class="map-container">
    <div class="tour-info">
        <h2 id="tourTitle">Tour Route</h2>
        <div class="tour-details" id="tourDetails">
            <div class="detail-item">
                <div class="detail-value" id="distanceValue">-</div>
                <div class="detail-label">Distance (km)</div>
            </div>
            <div class="detail-item">
                <div class="detail-value" id="timeValue">-</div>
                <div class="detail-label">Time (min)</div>
            </div>
            <div class="detail-item">
                <div class="detail-value" id="transportValue">-</div>
                <div class="detail-label">Transport</div>
            </div>
        </div>
    </div>

    <div id="map"></div>

    <div class="route-info" id="routeInfo">
        <strong>Route Information:</strong>
        <p id="routeDescription">Route details will appear here...</p>
    </div>

    <div class="loading" id="loading" style="display: none;">
        Loading route...
    </div>

    <div class="error" id="error" style="display: none;">
        Could not load route data.
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin=""></script>

<script>
    let map;
    let routeLayer;
    let startMarker;
    let endMarker;

    // Initialize the map
    function initMap() {
        // Default center (Europe)
        map = L.map('map').setView([48.2082, 16.3738], 6);

        // Add OpenStreetMap tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '¬© <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(map);
    }

    // Function to display a route on the map
    function displayRoute(routeData) {
        const { fromLocation, toLocation, fromCoords, toCoords, distance, time, transportType, routeGeometry } = routeData;

        // Update tour information
        updateTourInfo(fromLocation, toLocation, distance, time, transportType);

        // Clear existing markers and routes
        clearMap();

        // Add start marker
        startMarker = L.marker([fromCoords[1], fromCoords[0]], {
            icon: createCustomIcon('üèÅ', '#28a745')
        }).addTo(map);

        startMarker.bindPopup(`
                <div class="custom-popup">
                    <div class="popup-title">Start: ${fromLocation}</div>
                    <div>Coordinates: ${fromCoords[1].toFixed(4)}, ${fromCoords[0].toFixed(4)}</div>
                </div>
            `);

        // Add end marker
        endMarker = L.marker([toCoords[1], toCoords[0]], {
            icon: createCustomIcon('üèÜ', '#dc3545')
        }).addTo(map);

        endMarker.bindPopup(`
                <div class="custom-popup">
                    <div class="popup-title">Destination: ${toLocation}</div>
                    <div>Coordinates: ${toCoords[1].toFixed(4)}, ${toCoords[0].toFixed(4)}</div>
                </div>
            `);

        // If we have route geometry, display it
        if (routeGeometry && routeGeometry.length > 0) {
            const routeCoords = routeGeometry.map(coord => [coord[1], coord[0]]);
            routeLayer = L.polyline(routeCoords, {
                color: '#007bff',
                weight: 5,
                opacity: 0.8
            }).addTo(map);

            // Fit map to show the entire route
            const group = new L.featureGroup([startMarker, endMarker, routeLayer]);
            map.fitBounds(group.getBounds().pad(0.1));
        } else {
            // No route geometry, just show straight line and fit to markers
            const straightLine = L.polyline([
                [fromCoords[1], fromCoords[0]],
                [toCoords[1], toCoords[0]]
            ], {
                color: '#6c757d',
                weight: 3,
                opacity: 0.6,
                dashArray: '10, 10'
            }).addTo(map);

            const group = new L.featureGroup([startMarker, endMarker, straightLine]);
            map.fitBounds(group.getBounds().pad(0.2));
        }

        // Show route information
        showRouteInfo(fromLocation, toLocation, distance, time, transportType);
    }

    // Create custom icon
    function createCustomIcon(emoji, color) {
        return L.divIcon({
            html: `<div style="
                    background: ${color};
                    color: white;
                    border-radius: 50%;
                    width: 40px;
                    height: 40px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-size: 20px;
                    border: 3px solid white;
                    box-shadow: 0 2px 10px rgba(0,0,0,0.3);
                ">${emoji}</div>`,
            className: 'custom-marker',
            iconSize: [40, 40],
            iconAnchor: [20, 20]
        });
    }

    // Update tour information display
    function updateTourInfo(from, to, distance, time, transport) {
        document.getElementById('tourTitle').textContent = `${from} ‚Üí ${to}`;
        document.getElementById('distanceValue').textContent = distance ? distance.toFixed(1) : '-';
        document.getElementById('timeValue').textContent = time || '-';
        document.getElementById('transportValue').textContent = transport || '-';
    }

    // Show route information
    function showRouteInfo(from, to, distance, time, transport) {
        const routeInfo = document.getElementById('routeInfo');
        const description = document.getElementById('routeDescription');

        const hours = Math.floor(time / 60);
        const minutes = time % 60;
        const timeStr = hours > 0 ? `${hours}h ${minutes}min` : `${minutes}min`;

        description.innerHTML = `
                Route from <strong>${from}</strong> to <strong>${to}</strong><br>
                Distance: <strong>${distance.toFixed(1)} km</strong><br>
                Estimated time: <strong>${timeStr}</strong><br>
                Transport: <strong>${transport}</strong>
            `;

        routeInfo.classList.add('show');
    }

    // Clear all markers and routes from map
    function clearMap() {
        if (startMarker) {
            map.removeLayer(startMarker);
            startMarker = null;
        }
        if (endMarker) {
            map.removeLayer(endMarker);
            endMarker = null;
        }
        if (routeLayer) {
            map.removeLayer(routeLayer);
            routeLayer = null;
        }
    }

    // Show loading state
    function showLoading() {
        document.getElementById('loading').style.display = 'block';
        document.getElementById('error').style.display = 'none';
        document.getElementById('routeInfo').classList.remove('show');
    }

    // Show error state
    function showError(message) {
        document.getElementById('loading').style.display = 'none';
        document.getElementById('error').style.display = 'block';
        document.getElementById('error').textContent = message || 'Could not load route data.';
    }

    // Hide loading and error states
    function hideStates() {
        document.getElementById('loading').style.display = 'none';
        document.getElementById('error').style.display = 'none';
    }

    // Function that can be called from JavaFX
    function loadRoute(routeDataJson) {
        try {
            hideStates();
            const routeData = typeof routeDataJson === 'string' ? JSON.parse(routeDataJson) : routeDataJson;
            displayRoute(routeData);
        } catch (error) {
            console.error('Error loading route:', error);
            showError('Error parsing route data: ' + error.message);
        }
    }

    // Function to center map on coordinates
    function centerMap(lat, lng, zoom = 10) {
        if (map) {
            map.setView([lat, lng], zoom);
        }
    }

    // Initialize map when page loads
    document.addEventListener('DOMContentLoaded', function() {
        initMap();

        // Example data for testing (remove in production)
        // setTimeout(() => {
        //     const exampleData = {
        //         fromLocation: "Vienna",
        //         toLocation: "Graz",
        //         fromCoords: [16.3738, 48.2082],
        //         toCoords: [15.4395, 47.0707],
        //         distance: 194.2,
        //         time: 131,
        //         transportType: "Car",
        //         routeGeometry: [] // Empty for straight line
        //     };
        //     loadRoute(exampleData);
        // }, 1000);
    });

    // Expose functions to global scope for JavaFX access
    window.loadRoute = loadRoute;
    window.centerMap = centerMap;
    window.showLoading = showLoading;
    window.showError = showError;
</script>
</body>
</html>